<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>クーポン消込</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#06C755; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; }
    .spin { animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
    .shake { animation: shake .4s ease; } @keyframes shake { 10%,90%{transform:translateX(-2px)} 30%,70%{transform:translateX(4px)} 50%{transform:translateX(-6px)} }
    .fade-in { animation: fade .3s ease; } @keyframes fade { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-emerald-100">
  <div class="mx-auto max-w-md px-4 py-10">
    <div class="text-center mb-6">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-sm font-semibold">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm1 14h-2v-2h2zm0-4h-2V6h2z"/></svg>
        スタッフ用 消込画面
      </div>
      <h1 class="mt-3 text-2xl font-bold tracking-tight">クーポン確認・消込</h1>
    </div>

    <div class="relative rounded-2xl bg-white/90 shadow ring-1 ring-black/5 fade-in">
      <div class="p-5 sm:p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-sm text-gray-500">クーポンコード</p>
            <p id="code" class="mt-0.5 font-mono text-lg font-semibold tracking-widest">—</p>
          </div>
          <button id="copyBtn" class="text-xs px-3 py-1.5 rounded-full border border-gray-200 hover:bg-gray-50">コピー</button>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <div class="rounded-xl border border-gray-100 p-3">
            <p class="text-xs text-gray-500">ステータス</p>
            <div id="status" class="mt-1 inline-flex items-center gap-1.5 text-sm font-semibold text-emerald-700">
              <span class="w-2 h-2 rounded-full bg-emerald-500"></span> 未使用
            </div>
          </div>
          <div class="rounded-xl border border-gray-100 p-3">
            <p class="text-xs text-gray-500">残り使用回数</p>
            <p id="usage" class="mt-1 text-sm font-semibold">— / 2</p>
          </div>
        </div>

        <div class="mt-5">
          <label class="block text-sm font-medium mb-1">スタッフパス</label>
          <div class="relative">
            <input id="pass" type="password" inputmode="numeric"
              class="w-full rounded-xl border border-gray-200/80 px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-emerald-200"
              placeholder="****">
            <button id="togglePass" class="absolute inset-y-0 right-2 my-auto px-2 text-gray-400 hover:text-gray-600" type="button" aria-label="表示切替">
              <svg id="eyeOpen" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 115-5 5 5 0 01-5 5z"/><circle cx="12" cy="12" r="2.5"/></svg>
              <svg id="eyeClose" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M2 4.27L3.28 3 21 20.72 19.73 22 16.9 19.17A11.77 11.77 0 0112 19c-7 0-10-7-10-7a17.59 17.59 0 014.93-5.53l-2.2-2.2zM12 7a5 5 0 015 5 4.93 4.93 0 01-.45 2L9.06 7.51A4.9 4.9 0 0112 7z"/></svg>
            </button>
          </div>
        </div>

        <div class="mt-6 flex gap-2">
          <button id="useBtn" class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-[var(--brand)] px-4 py-3 font-semibold text-white hover:opacity-95 focus:outline-none disabled:opacity-60 disabled:cursor-not-allowed">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17a2 2 0 002-2V7a2 2 0 10-4 0v8a2 2 0 002 2z"/><path d="M5 10a2 2 0 00-2 2v5h18v-5a2 2 0 00-2-2H5z"/></svg>
            1回使う
          </button>
          <button id="reloadBtn" class="px-4 py-3 rounded-xl border border-gray-200 hover:bg-gray-50">更新</button>
        </div>

        <p id="msg" class="mt-4 text-sm text-gray-600"></p>
        <p class="mt-5 text-xs text-gray-500">※ 会計時にスタッフが押してください。二重押下を防ぐため、処理完了までお待ちください。</p>
      </div>
    </div>

    <p class="mt-6 text-center text-xs text-gray-400">© Coupon System</p>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const code = new URL(location.href).searchParams.get('code') || '';
    $('#code').textContent = code || '—';

    $('#copyBtn').onclick = async()=>{
      if (!code) return;
      await navigator.clipboard.writeText(code);
      toast('コードをコピーしました');
    };

    $('#togglePass').onclick = ()=>{
      const i = $('#pass');
      const o = $('#eyeOpen'), c = $('#eyeClose');
      if (i.type === 'password') { i.type='text';  o.classList.add('hidden'); c.classList.remove('hidden'); }
      else { i.type='password'; o.classList.remove('hidden'); c.classList.add('hidden'); }
    };

    $('#useBtn').onclick = redeem;
    $('#pass').addEventListener('keydown', e=>{ if(e.key==='Enter') redeem(); });
    $('#reloadBtn').onclick = ()=>location.reload();

    async function redeem(){
      const pass = $('#pass').value.trim();
      if (!code) return toast('コードが見つかりません', true);

      setLoading(true);
      try {
        const res = await fetch('/redeem', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ code, pass })
        });
        const json = await res.json().catch(()=>({}));
        const ok = json.ok === true || json.status === 'OK' || res.ok;

        if (ok) {
          $('#status').innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> 消込済み`;
          if (json.remain != null && json.limit != null) {
            $('#usage').textContent = `${json.remain} / ${json.limit}`;
          }
          $('#msg').textContent = json.message || '消込が完了しました。';
          confetti(); $('#useBtn').disabled = true;
        } else {
          const reason = (json.status || json.message || '').toString().toUpperCase();
          if (reason.includes('PASS') || reason.includes('AUTH')) {
            shake('#pass'); $('#msg').textContent = 'スタッフパスが正しくありません。';
          } else if (reason.includes('EXPIRE')) {
            $('#status').innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> 期限切れ`;
            $('#msg').textContent = json.message || 'クーポンの有効期限が切れています。';
            $('#useBtn').disabled = true;
          } else if (reason.includes('CONSUM') || reason.includes('LIMIT')) {
            $('#status').innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500"></span> 上限に達しました`;
            $('#msg').textContent = json.message || '使用上限に達しています。';
            $('#useBtn').disabled = true;
          } else {
            $('#msg').textContent = json.message || '処理できませんでした。時間をおいて再度お試しください。';
            shake('#useBtn');
          }
        }
      } catch (e) {
        console.error(e);
        $('#msg').textContent = '通信に失敗しました。ネットワーク環境をご確認ください。';
        shake('#useBtn');
      } finally { setLoading(false); }
    }

    function setLoading(is){
      $('#useBtn').disabled = is;
      $('#useBtn').innerHTML = is
        ? `<svg class="h-5 w-5 spin" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9" stroke-width="3" class="opacity-20"/><path d="M21 12a9 9 0 00-9-9" stroke-width="3"/></svg> 処理中...`
        : `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17a2 2 0 002-2V7a2 2 0 10-4 0v8a2 2 0 002 2z"/><path d="M5 10a2 2 0 00-2 2v5h18v-5a2 2 0 00-2-2H5z"/></svg> 1回使う`;
    }
    function shake(sel){ const el=$(sel); el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake'); }
    function toast(msg, danger){
      const t=document.createElement('div');
      t.textContent=msg;
      t.className=`fixed left-1/2 -translate-x-1/2 bottom-6 z-50 px-4 py-2 rounded-lg text-white text-sm shadow-lg fade-in ${danger?'bg-red-500':'bg-black/80'}`;
      document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
    }
    function confetti(){
      const c=document.createElement('canvas'); c.width=window.innerWidth; c.height=200;
      c.className='fixed left-0 right-0 top-16 z-40 pointer-events-none'; document.body.appendChild(c);
      const ctx=c.getContext('2d'); const ps=Array.from({length:80},()=>({x:Math.random()*c.width, y:-20, r:2+Math.random()*3, v:2+Math.random()*3, h:Math.random()*360}));
      let t=0; (function loop(){ ctx.clearRect(0,0,c.width,c.height); ps.forEach(p=>{p.y+=p.v; ctx.fillStyle=`hsl(${p.h},80%,60%)`; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,6.28); ctx.fill();}); if(t++<60) requestAnimationFrame(loop); else c.remove(); })();
    }
  </script>
</body>
</html>
