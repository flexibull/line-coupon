<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>クーポン消込</title>
<style>
  body { font-family: system-ui, sans-serif; padding: 20px; }
  .ok { background: #e6ffed; padding: 10px; border-radius: 8px; }
  .ng { background: #ffecec; padding: 10px; border-radius: 8px; }
  button { padding: 12px 16px; border-radius: 10px; border: 0; }
  input { padding: 10px; width: 100%; margin: 6px 0 12px; }
</style>
<h2>クーポン消込（スタッフ用）</h2>
<div id="view">
  <p>クーポンコード：</p>
  <input id="code">
  <p>スタッフパス：</p>
  <input id="pass" type="password" placeholder="（設定している場合）">
  <button id="use">1回使う</button>
  <div id="result"></div>
</div>
<script>
  const p = new URLSearchParams(location.search);
  const code = p.get('code') || '';
  document.querySelector('#code').value = code;
  document.querySelector('#use').onclick = async () => {
    const res = await fetch('/api/redeem', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        code: document.querySelector('#code').value.trim(),
        staffPass: document.querySelector('#pass').value.trim()
      })
    });
    const data = await res.json();
    const box = document.querySelector('#result');
    if (data.ok) {
      box.className = 'ok';
      box.innerHTML = `<h3>OK</h3><p>使用回数：${data.usageCount} / ${data.usageLimit}</p><p>状態：${data.status}</p>`;
    } else {
      box.className = 'ng';
      box.innerHTML = `<h3>NG</h3><p>${data.reason || 'ERROR'}</p>`;
    }
  };
</script>
